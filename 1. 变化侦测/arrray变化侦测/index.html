<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Array变化侦测</title>
</head>
<body>
  <script>
    const arrayMethods = Object.create(Array.prototype)
    let mutateMethods = ['pop', 'push', 'shift', 'unshift', 'sort', 'splice', 'reverse']
    // 是否支持__proto__的方法
    const hasProto = '__proto__' in {}

    // 拦截数组突变方法
    mutateMethods.forEach(function (method) {
      let original = arrayMethods[method]
      Object.defineProperty(arrayMethods, method, {
        value: function (...args) {
          let value = original.apply(this, args)

          return value
        },
        enumerable: false,
        writable: true,
        configurable: true
      })
    })

    function protoAugment(value, src, keys) {
      value.__proto__ = src
    }

    function copyAugment(value, src, keys) {
      for (let i = 0; i < keys.length; i++) {
        let key = keys[i]
        def(value, key, src[key])
      }
    }

    // 定义属性
    function def (obj, key, value, enumerable) {
      Object.defineProperty(obj, key, {
        value: value,
        enumerable: !!enumerable,
        writable: true,
        configurable: true
      })
    }

    class Observer {
      constructor(value) {
        this.value = value

        if (Array.isArray(value)) {
          // 拦截
          // value.__proto__ = arrayMethods
          let augment = hasProto ? protoAugment : copyAugment
          augment(value, arrayMethods, mutateMethods)
        } else {
          // 将每个属性变为响应式
          this.walk(value)
        }
      }
    }

  </script>
</body>
</html>